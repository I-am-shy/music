<script setup>//组合式API
import { ref, watch, onMounted, defineEmits } from 'vue';
import { useSongStore, useAudio } from '@/stores/song';

const emit = defineEmits(['v-open'])

const songStore = useSongStore();
const Audio = useAudio();
const audio = ref();
const songTime = ref(0);//歌曲总时长
const openList = ref(false);//默认不展示播放列表



onMounted(() => {
  Audio.audio = audio.value;
  audio.value.oncanplay = () => {
    // console.log(audio.value.duration);
    songTime.value = parseInt(audio.value.duration);
  }
  audio.value.ontimeupdate = () => {
    Audio.currentTime = parseInt(audio.value.currentTime);
    if (Audio.currentTime == parseInt(Audio.audio.duration)) {//播放完毕
      next();
    }
  }
})

watch([Audio], () => {
  if (Audio.playing) {
    audio.value.play();
  } else {
    audio.value.pause();
  }
}, {
  deep: true
})

// 播放/暂停
const onPlay = () => {
  if (Audio.playing) {
    // audio.value.pause();
    Audio.playing = false;
  } else {
    // audio.value.play();
    Audio.playing = true;

  }
}
// 上一首
const pre = () => {
  songStore.playPrev();
}
// 下一首
const next = () => {
  songStore.playNext();
}

// 秒转换时分钟00:00:00时分秒格式：
function timeToMinute(times) {
  let t;
  if (times > -1) {
    let hour = Math.floor(times / 3600);
    let min = Math.floor(times / 60) % 60;
    let sec = times % 60;
    if (hour < 10) {
      t = '0' + hour + ":";
    } else {
      t = hour + ":";
    }

    if (min < 10) {
      t += "0";
    }
    t += min + ":";
    if (sec < 10) {
      t += "0";
    }
    t += sec.toFixed(2);
  }
  if (t) {
    t = t.substring(0, t.length - 3);// 对t判断是否非空，否则会产生一个错误（不影响实际使用）
  }
  return t;
}

// 更新进度条
const updateRange = () => {
  audio.value.currentTime = Audio.currentTime;
  // console.log(currentTime.value);
}

// 打开/关闭播放列表
const open = () => {
  openList.value = true;
  emit('v-open', openList.value);//向父组件传递值
}


</script>

<template>
  <div class="player">
    <div class="img">
      <router-link to="/player">
        <img width="50" :src="songStore.playSong.cover" alt="">
      </router-link>
    </div>

    <div class="info">
      <span>{{ songStore.playSong.song_name }}</span>
      <span>{{ songStore.playSong.song_singer }}</span>
    </div>

    <div class="audio">
      <div class="controls">
        <v-btn variant="text" size="small" icon="">
          <template v-slot:default>
            <i @click="pre">
              <svg t="1718884764682" class="icon" viewBox="0 0 1024 1024" version="1.1"
                xmlns="http://www.w3.org/2000/svg" p-id="1173" width="32" height="32" fill="#4b4b4b">
                <path
                  d="M512 62.389956c-248.312412 0-449.610044 201.297632-449.610044 449.610044s201.297632 449.610044 449.610044 449.610044 449.610044-201.297632 449.610044-449.610044S760.312412 62.389956 512 62.389956zM786.507004 786.507004c-35.672454 35.672454-77.196173 63.672158-123.416867 83.222423-47.821145 20.22667-98.655927 30.482245-151.09116 30.482245-52.435233 0-103.270015-10.255575-151.09116-30.482245-46.220694-19.549242-87.744413-47.549969-123.416867-83.222423-35.672454-35.672454-63.672158-77.196173-83.222423-123.416867-20.22667-47.821145-30.482245-98.655927-30.482245-151.090137 0-52.435233 10.255575-103.270015 30.482245-151.09116 19.549242-46.220694 47.549969-87.744413 83.222423-123.416867 35.672454-35.672454 77.196173-63.672158 123.416867-83.222423 47.821145-20.22667 98.654904-30.482245 151.09116-30.482245 52.435233 0 103.268992 10.255575 151.09116 30.482245 46.220694 19.549242 87.744413 47.549969 123.416867 83.222423 35.672454 35.672454 63.672158 77.196173 83.222423 123.416867 20.22667 47.821145 30.482245 98.655927 30.482245 151.09116 0 52.435233-10.255575 103.268992-30.482245 151.090137C850.179163 709.310831 822.179458 750.83455 786.507004 786.507004z"
                  p-id="1174"></path>
                <path
                  d="M715.830315 305.667701 448.346261 507.980453c-3.094478 1.786693-3.094478 6.252401 0 8.039093l267.484054 202.312752c3.094478 1.786693 6.961552-0.446162 6.961552-4.019547l0-404.625504C722.791867 306.113863 718.924793 303.881009 715.830315 305.667701z"
                  p-id="1175"></path>
                <path
                  d="M398.078391 306.049395l-92.229564 0c-2.563382 0-4.640694 2.365884-4.640694 5.28333l0 401.334551c0 2.917446 2.078335 5.28333 4.640694 5.28333l92.229564 0c2.563382 0 4.641717-2.365884 4.641717-5.28333L402.720108 311.332724C402.719084 308.415278 400.641773 306.049395 398.078391 306.049395z"
                  p-id="1176"></path>
              </svg>
            </i>
          </template>
        </v-btn>
        <v-btn variant="text" size="small" icon="">
          <template v-slot:default>
            <i v-if="!Audio.playing" @click="onPlay">
              <svg t="1718884796272" class="icon" viewBox="0 0 1024 1024" version="1.1"
                xmlns="http://www.w3.org/2000/svg" p-id="1433" width="32" height="32" fill="#4b4b4b">
                <path
                  d="M512 62.389956c-248.312412 0-449.610044 201.297632-449.610044 449.610044s201.297632 449.610044 449.610044 449.610044 449.610044-201.297632 449.610044-449.610044S760.312412 62.389956 512 62.389956zM786.507004 786.507004c-35.672454 35.672454-77.196173 63.672158-123.416867 83.222423-47.821145 20.22667-98.655927 30.482245-151.09116 30.482245-52.435233 0-103.270015-10.255575-151.09116-30.482245-46.220694-19.549242-87.744413-47.549969-123.416867-83.222423-35.672454-35.672454-63.672158-77.196173-83.222423-123.416867-20.22667-47.821145-30.482245-98.655927-30.482245-151.090137 0-52.435233 10.255575-103.270015 30.482245-151.09116 19.549242-46.220694 47.549969-87.744413 83.222423-123.416867 35.672454-35.672454 77.196173-63.672158 123.416867-83.222423 47.821145-20.22667 98.654904-30.482245 151.09116-30.482245 52.435233 0 103.268992 10.255575 151.09116 30.482245 46.220694 19.549242 87.744413 47.549969 123.416867 83.222423 35.672454 35.672454 63.672158 77.196173 83.222423 123.416867 20.22667 47.821145 30.482245 98.655927 30.482245 151.09116 0 52.435233-10.255575 103.268992-30.482245 151.090137C850.179163 709.310831 822.179458 750.83455 786.507004 786.507004z"
                  p-id="1434"></path>
                <path
                  d="M727.558427 506.975567l-334.355067-252.891707c-3.868097-2.232854-8.702196 0.558725-8.702196 5.024433l0 505.782392c0 4.465708 4.834098 7.257288 8.702196 5.024433l334.355067-252.890684C731.426525 514.791579 731.426525 509.208421 727.558427 506.975567z"
                  p-id="1435"></path>
              </svg>
            </i>
            <i v-else @click="onPlay">
              <svg t="1718884836058" class="icon" viewBox="0 0 1024 1024" version="1.1"
                xmlns="http://www.w3.org/2000/svg" p-id="1644" width="32" height="32" fill="#4b4b4b">
                <path
                  d="M512 62.389956c-248.312412 0-449.610044 201.297632-449.610044 449.610044s201.297632 449.610044 449.610044 449.610044 449.610044-201.297632 449.610044-449.610044S760.312412 62.389956 512 62.389956zM786.507004 786.507004c-35.672454 35.672454-77.196173 63.672158-123.416867 83.222423-47.821145 20.22667-98.655927 30.482245-151.09116 30.482245-52.435233 0-103.270015-10.255575-151.09116-30.482245-46.220694-19.549242-87.744413-47.549969-123.416867-83.222423-35.672454-35.672454-63.672158-77.196173-83.222423-123.416867-20.22667-47.821145-30.482245-98.655927-30.482245-151.090137 0-52.435233 10.255575-103.270015 30.482245-151.09116 19.549242-46.220694 47.549969-87.744413 83.222423-123.416867 35.672454-35.672454 77.196173-63.672158 123.416867-83.222423 47.821145-20.22667 98.654904-30.482245 151.09116-30.482245 52.435233 0 103.268992 10.255575 151.09116 30.482245 46.220694 19.549242 87.744413 47.549969 123.416867 83.222423 35.672454 35.672454 63.672158 77.196173 83.222423 123.416867 20.22667 47.821145 30.482245 98.655927 30.482245 151.09116 0 52.435233-10.255575 103.268992-30.482245 151.090137C850.179163 709.310831 822.179458 750.83455 786.507004 786.507004z"
                  p-id="1645"></path>
                <path
                  d="M699.168844 285.84933 583.882144 285.84933c-3.203972 0-5.801123 2.597151-5.801123 5.801123l0 440.698071c0 3.203972 2.597151 5.801123 5.801123 5.801123l115.2867 0c3.203972 0 5.801123-2.597151 5.801123-5.801123L704.969966 291.650453C704.97099 288.446481 702.373839 285.84933 699.168844 285.84933z"
                  p-id="1646"></path>
                <path
                  d="M440.117856 285.84933 324.830133 285.84933c-3.203972 0-5.801123 2.597151-5.801123 5.801123l0 440.698071c0 3.203972 2.597151 5.801123 5.801123 5.801123L440.117856 738.149647c3.203972 0 5.801123-2.597151 5.801123-5.801123L445.918979 291.650453C445.918979 288.446481 443.321828 285.84933 440.117856 285.84933z"
                  p-id="1647"></path>
              </svg>
            </i>
          </template>
        </v-btn>
        <v-btn variant="text" size="small" icon="">
          <template v-slot:default>
            <i @click="next">
              <svg t="1718884844250" class="icon" viewBox="0 0 1024 1024" version="1.1"
                xmlns="http://www.w3.org/2000/svg" p-id="1856" width="32" height="32" fill="#4b4b4b">
                <path
                  d="M512 62.389956c-248.312412 0-449.610044 201.297632-449.610044 449.610044s201.297632 449.610044 449.610044 449.610044 449.610044-201.297632 449.610044-449.610044S760.312412 62.389956 512 62.389956zM786.507004 786.507004c-35.672454 35.672454-77.196173 63.672158-123.416867 83.222423-47.821145 20.22667-98.655927 30.482245-151.09116 30.482245-52.435233 0-103.270015-10.255575-151.09116-30.482245-46.220694-19.549242-87.744413-47.549969-123.416867-83.222423-35.672454-35.672454-63.672158-77.196173-83.222423-123.416867-20.22667-47.821145-30.482245-98.655927-30.482245-151.090137 0-52.435233 10.255575-103.270015 30.482245-151.09116 19.549242-46.220694 47.549969-87.744413 83.222423-123.416867 35.672454-35.672454 77.196173-63.672158 123.416867-83.222423 47.821145-20.22667 98.654904-30.482245 151.09116-30.482245 52.435233 0 103.268992 10.255575 151.09116 30.482245 46.220694 19.549242 87.744413 47.549969 123.416867 83.222423 35.672454 35.672454 63.672158 77.196173 83.222423 123.416867 20.22667 47.821145 30.482245 98.655927 30.482245 151.09116 0 52.435233-10.255575 103.268992-30.482245 151.090137C850.179163 709.310831 822.179458 750.83455 786.507004 786.507004z"
                  p-id="1857"></path>
                <path
                  d="M575.653739 507.980453 308.169685 305.667701c-3.094478-1.786693-6.961552 0.446162-6.961552 4.019547l0 404.625504c0 3.572362 3.868097 5.806239 6.961552 4.019547l267.484054-202.312752C578.747193 514.232854 578.747193 509.767146 575.653739 507.980453z"
                  p-id="1858"></path>
                <path
                  d="M718.151174 306.049395l-92.229564 0c-2.563382 0-4.640694 2.365884-4.640694 5.28333l0 401.334551c0 2.917446 2.078335 5.28333 4.640694 5.28333l92.229564 0c2.563382 0 4.640694-2.365884 4.640694-5.28333L722.791867 311.332724C722.791867 308.415278 720.714556 306.049395 718.151174 306.049395z"
                  p-id="1859"></path>
              </svg>
            </i>
          </template>
        </v-btn>

      </div>
      <div class="time">{{ timeToMinute(Audio.currentTime) + '/' + timeToMinute(songTime ? songTime : 0) }}</div>
      <v-slider :max="songTime" :min="0" :step="1" id="range" width="120%" thumb-size="10" v-model="Audio.currentTime"
        @end="updateRange"></v-slider>
    </div>

    <div class="list">
      <v-btn variant="text" size="">
        <i @click="open">
          <svg t="1718886919273" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
            p-id="8389" width="32" height="32" fill="#4b4b4b">
            <path
              d="M187.392 70.656q28.672 0 48.64 19.456t19.968 48.128l0 52.224q0 28.672-19.968 48.64t-48.64 19.968l-54.272 0q-27.648 0-47.616-19.968t-19.968-48.64l0-52.224q0-28.672 19.968-48.128t47.616-19.456l54.272 0zM889.856 70.656q27.648 0 47.616 19.456t19.968 48.128l0 52.224q0 28.672-19.968 48.64t-47.616 19.968l-437.248 0q-28.672 0-48.64-19.968t-19.968-48.64l0-52.224q0-28.672 19.968-48.128t48.64-19.456l437.248 0zM187.392 389.12q28.672 0 48.64 19.968t19.968 48.64l0 52.224q0 27.648-19.968 47.616t-48.64 19.968l-54.272 0q-27.648 0-47.616-19.968t-19.968-47.616l0-52.224q0-28.672 19.968-48.64t47.616-19.968l54.272 0zM889.856 389.12q27.648 0 47.616 19.968t19.968 48.64l0 52.224q0 27.648-19.968 47.616t-47.616 19.968l-437.248 0q-28.672 0-48.64-19.968t-19.968-47.616l0-52.224q0-28.672 19.968-48.64t48.64-19.968l437.248 0zM187.392 708.608q28.672 0 48.64 19.968t19.968 47.616l0 52.224q0 28.672-19.968 48.64t-48.64 19.968l-54.272 0q-27.648 0-47.616-19.968t-19.968-48.64l0-52.224q0-27.648 19.968-47.616t47.616-19.968l54.272 0zM889.856 708.608q27.648 0 47.616 19.968t19.968 47.616l0 52.224q0 28.672-19.968 48.64t-47.616 19.968l-437.248 0q-28.672 0-48.64-19.968t-19.968-48.64l0-52.224q0-27.648 19.968-47.616t48.64-19.968l437.248 0z"
              p-id="8390"></path>
          </svg>
        </i>
      </v-btn>

    </div>

    <audio :src="songStore.playSong.music_url" autoplay ref="audio"></audio>

  </div>

</template>

<style scoped lang='scss'>
/* 当 <style> 标签带有 scoped attribute 的时候，它的 CSS 只会影响当前组件的元素 */
.player {
  display: flex;
  justify-content: start;

  .img {
    width: 50px;
    height: 50px;
    margin: 4px;
    display: inline-block;

  }

  .info {
    display: flex;
    flex-direction: column;
    width: 220px;

    span {
      width: 220px;
      text-wrap: nowrap;
      overflow: hidden;
      font-size: 0.8em;
      margin-left: 10px;
    }

    span:nth-child(1) {
      font-size: 1.4em;
    }

  }

  .audio {
    width: 800px;
    height: 60px;
    margin-left: 10px;

    .controls {
      width: 800px;
      height: 30px;
      display: flex;
      justify-content: start;

      .icon {
        margin-top: 5px;
      }
    }

    .time {
      display: inline-block;
      position: absolute;
      width: 150px;
      height: 20px;
      top: 20px;
      right: 200px;
    }
  }

  .list {
    width: 80px;
    height: 60px;
    display: flex;
    justify-content: center;
    align-items: center;
    margin-left: 300px;

    i {
      width: 40px;
      height: 40px;
      border-radius: 3px;

      .icon {
        margin-left: 5px;
        margin-top: 5px;
      }
    }
  }
}
</style>